---
title: "FRRO2Compare"
author:

- Douglas A. Campbell
- Maximilian Berthold
output:
  html_document:
    df_print: paged
    code_folding: hide
    keep_md: yes
    fig_caption: yes
    toc: TRUE
    toc_float: TRUE
csl: plos-one.csl
---

##Introduction
Compare [O2] to FRRf data.

##ToDo
Read in Optode Data
Read in FRRf Data
Fit slopes to O2data over time windows defined by FRRf changes in PAR
Compare O2 slopes to FRR ETR estimates


# Set Chunk Options
```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
knitr::opts_chunk$set(fig.path='Figs/')
```

```{r set project variables}
#"..", takes up a level in the directory path
Project <- "FluorO2"
DataInO2 <- file.path("..","ImportData", "Optode")
DataInFRRf <- file.path("..","ImportData", "FRRf")
#MetaCatalog <- file.path("..","PicoCatalog.csv")


```

```{r load libraries} 
# libraries; Note check actual dependencies
library(tidyverse)
library(lubridate)
library(stringr)
library(broom)
library(knitr)
#library(zoo)
library(tidyquant)
library(googlesheets4)
library(googledrive)
#library(dplyr)
```

```{r set colours}
Wavelengths_nm = c(445, 470, 505, 535, 590)
Colours_nm = c("darkblue", "dodgerblue", "darkgreen", "yellowgreen",  "darkorange")


names(Colours_nm) <- Wavelengths_nm
Colours_nm

```

This chunk reads in the MetaData catalog from googlesheets 
```{r load Catalog, now as a google sheet}
# gs4_deauth()
# #deauthorizes access to googlesheet
# 
# MetaCatalog <- read_sheet("https://docs.google.com/spreadsheets/d/1ZXpwR7Gfto-uRzVdXzMpQF4frbrvMLH_IyLqonFZRSw/edit#gid=0") %>%
# # sheet is read in by sheet ID, obtained from the URL of the sheet.
# # read_sheet has an annoying "feature" to set the type of columns it can't parse to a list.
# # ggplot/dplyr doesn't like working with a dataframe of lists.
# # In this case WL is set to a list since some values are numbers, some are strings, some are blank.
# # To fix this, first drop all rows missing WL, then unlist.
# # Must first drop NA rows since unlist will collapse NULL lists, then the unlisted WL is a shorter length than original WL column, which mutate doesn't like.
# 
# drop_na(WL) %>%
#   mutate(WL = unlist(WL))
# 
# as.data.frame(MetaCatalog)
```

Tidy the catalog, making dates as date values, tube as character, and wavelenth as a character
```{r}
# TidyCatalog <- MetaCatalog %>%
#   mutate(InnocDate = ymd(InnocDate),
#          ExpDate = ymd(ExpDate), 
#          Tube = as.character(Tube)) %>% 
#   select(-c(PrimaryOperator, Description, Motivation, doi, Source, SourceSalinity, Plate, Well))
# 
# #Catalog <- MetaCatalog %>%
#   #mutate(InnocDate = ymd(InnocDate),
#          #ExpDate = ymd(ExpDate),
#          #Tube = as.character(Tube)) %>%
#   #select(-c(PrimaryOperator, Description, Motivation, doi))
# 
# #check catalog for correct selections
# 
#   TidyCatalog
```



Read in O2Data and FRRfData
Make this more general as we accumulate more files.
```{r read data}
O2Data <- readRDS(file = file.path(DataInO2, "FluorO2_O2Data.Rds"))
FRRfData <- readRDS(file = file.path(DataInFRRf, "FluorO2_SolFitsTrim.Rds"))

```

Remove missing rows, reconcile time formats
```{r remove missing rows}
O2Data <- O2Data %>%
  filter(!is.na(LR_s)) %>%
  mutate(Date = dmy(Date),
         AbsTime = as.period(AbsTime))

FRRfData <- FRRfData %>%
  filter(!is.na(LR_s))
```

```{r prelimplot}
O2Data %>%
  ggplot() +
  geom_point(aes(x = LR_s, y = O2_umolL, colour = Ex_WL)) +
  #geom_point(aes(x = FRRfData$LR_s, y = FRRfData$JVPSII_aLHIIminmax)) +
  scale_colour_manual(values = Colours_nm) +
  facet_grid(rows = vars(Ex_WL), cols = vars(CultureID)) +
  theme_bw()

FRRfData %>%
  filter(Dark1s == 0) %>%
  ggplot() +
  geom_point(aes(x = LR_s, y = JVPSII_aLHIIminmax)) +
  #geom_point(aes(x = O2Data$LR_s, y = O2Data$O2_umolL, colour = Ex_WL)) +
  scale_colour_manual(values = Colours_nm) +
  facet_grid(rows = vars(Ex_WL), cols = vars(CultureID)) +
  theme_bw()
```

#Try Simple left_join, in case times line up

```{r leftjoin}
O2FRRfData <- left_join(x = O2Data, y = FRRfData, by = c(c("Date" = "ObsDate"), c("AbsTime" = "ObsTime"), "CultureID", "Ex_WL"), suffix = c("O2", "FRRf"))
```

```{r prelimplot2}
O2FRRfData %>%
  ggplot() +
  geom_point(aes(x = LR_sO2, y = O2_umolL, colour = Ex_WL)) +
  geom_point(aes(x = LR_sFRRf, y = JVPSII_aLHIIminmax)) +
  scale_colour_manual(values = Colours_nm) +
  facet_grid(rows = vars(Ex_WL), cols = vars(CultureID)) +
  theme_bw()

```


```{r save O2FRRfData}
saveRDS(O2Data, file.path(DataOut, paste(Project, "O2Data.Rds", sep = "_"), fsep = .Platform$file.sep))
```


